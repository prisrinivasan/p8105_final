---
title: "Preliminary Analyses"
output:
   html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(PerformanceAnalytics)
library(sf)
library(sp)
library(tmap)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(MASS)
library(modelr)
library(mgcv)
library(leaps)

tidy_asthma = 
  read_csv(file = "./final_data/tidy_asthma.csv")

tidy_asthma 
```

## _Method_
The dataset we used was compiled using the Environmental and Health Dataset from the NYC Health Department. We selected variables based on our preliminary hypothesis regarding asthma, poverty, neighborhood, cockroaches, and school children. These analyses are exploring the correlations and relationships. The correlation matrix displays associations between all of our predictors and outcome to indicate any multicollinearity. The crude analysis shows the crude relationship between cockroach presence and childhood asthma. Finally, the linear model demonstrates the model with all of our predictors against our outcome. 

The code for this page can be found [here](https://github.com/prisrinivasan/p8105_final/blob/master/regression.Rmd). 

## _Cockroaches and Asthma by Borough_

```{r, echo = FALSE}

shape = st_read("./final_data/shapefiles/", quiet = TRUE)

tidy_asthma_sf = merge(shape, tidy_asthma, by.x = "UHFCODE", by.y = "geo_join_id") %>% 
  janitor::clean_names() %>% 
  mutate(uhfcode = as.character(uhfcode),
         time_period = as.character(time_period),
         homes_with_cockroaches = as.numeric(homes_with_cockroaches))

roach_asth_borough = 
  tidy_asthma_sf %>%
  filter(time_period == c("2011", "2014")) %>%
  mutate(borough = forcats::fct_reorder(borough, public_school_children_5_14_yrs_old_with_asthma, na.rm = TRUE)) %>%
  ggplot(aes(x = homes_with_cockroaches, 
             y = public_school_children_5_14_yrs_old_with_asthma,
             color = homes_with_cockroaches)) +
  geom_violin(aes(color = homes_with_cockroaches)) +
  viridis::scale_color_viridis(discrete = TRUE) +
  facet_grid(~borough) +
  labs(title = "Cockroach and Asthma Distribution by Borough",
       x = "Cockroach Distribution",
       y = "Asthma Among School Children Ages 5-14 years old")

roach_asth_borough

```

To first assess if this issue was one worth looking into, we analyzed the cockroach and asthma relationship by borough. Our prediction was that boroughs with higher cockroach distributions would have higher asthma rates. These violin plots support our initial hypothesis with the Bronx having both the highest cockroach distribution and asthma rates.

## _Correlation Matrix_
```{r, echo = FALSE}

chart.Correlation(tidy_asthma[,5:9], histogram = TRUE, method = c("pearson", "kendall", "spearman"))
```

A correlation matrix was then compiled to analyze our other predictors. The correlation matrix displays the baseline association between each variable. All of the correlations are above 0.53 which indicates fairly strong correlation. As we model build we will be aware of any multicollinearity from those variables with large correlations. 

## _Crude Association between Childhood Asthma and Cockroaches in the Home_

```{r, echo = FALSE}
set.seed(10)
library(ggplot2)

ggplot_data = 
tidy_asthma %>%
  filter(time_period == c("2011", "2014"))

plot_tidy = 
ggplot(ggplot_data, aes(x = homes_with_cockroaches, y = public_school_children_5_14_yrs_old_with_asthma, color = homes_with_cockroaches)) +
  geom_point() + 
  geom_smooth(method = "lm") +
  facet_grid(~time_period) +
  labs(x = "Percent of Homes with Cockroaches",
       y = "Percent of School Children with Asthma",
       title = "Crude Association Homes with Cockroaches and Childhood Asthma") +
  viridis::scale_color_viridis(aes(color = homes_with_cockroaches), discrete = FALSE)

plot_tidy

```

Our crude relationship between childhood asthma and cockroaches in the home is demonstrated here. As the percent of homes with cockroaches increases, so does the number of public school children with asthma. This is not a perfectly linear correlation, but on average, it is a positive linear correlation. 


## _Tables_
```{r, echo = FALSE}
ggplot_data = 
tidy_asthma %>%
  filter(time_period == c("2011", "2014"))

linear_model = 
  lm(public_school_children_5_14_yrs_old_with_asthma ~ homes_with_cockroaches * poverty * geo_join_id, data = ggplot_data)

## Model 1
model1_fit = lm(public_school_children_5_14_yrs_old_with_asthma ~ homes_with_cockroaches + poverty + geo_join_id, data=ggplot_data) 

## Model 5
model5_fit = lm(public_school_children_5_14_yrs_old_with_asthma ~ homes_with_cockroaches * poverty * geo_join_id * asthma_hospitalizations_children_5_to_17_yrs_old, data=ggplot_data)
```

```{r, echo = FALSE}

tab_model(model1_fit, linear_model, model5_fit)
```

---
This table displays the values for each of our four potential models. The three columns of "Public School Children 5-14 Years Old With Asthma" represent the three potential models. Geo Join ID is a proxy for neighborhood and demonstrates the relationship between neighborhood and asthma rates.

* The first column shows the basic model with 3 slopes: homes with cockroaches, poverty, geo_join_id. The ${r}^2$ value is 0.436 which isn't high, but isn't super low. 
* The second column shows one adjusted model based on our first crude model. Here we experiment with interactions terms to improve the ${r}^2$ value and find a better fit of our data. There are 7 slopes with three two-way interaction terms and one three-way interaction term between homes with cockroaches, poverty, and geo join id. The ${r}^2$ value is 0.589 which is higher than the crude model. 
* The third column shows another adjusted model. There are 15 slopes with all of the possible interactions between poverty, asthma hospitalizations, homes with cockroaches, and geo join id. The ${r}^2$ value is 0.887 which is much higher than the crude. This table demonstrates a significant interaction between our variables. 



